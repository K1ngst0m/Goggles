name: Shader Validation

on:
  workflow_dispatch:

jobs:
  full-shader-scan:
    name: Full Shader Scan
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download RetroArch shaders
      run: ./scripts/task/shader-fetch.sh

    - name: Cache CPM dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/CPM
        key: ${{ runner.os }}-cpm-${{ hashFiles('cmake/Dependencies.cmake') }}

    - name: Install Vulkan SDK
      run: |
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list https://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list
        sudo apt-get update
        sudo apt-get install -y vulkan-sdk

    - name: Install dependencies
      run: |
        sudo apt-get install -y cmake ninja-build \
          libx11-dev libxext-dev libxrandr-dev libxi-dev libxcursor-dev libxss-dev

    - name: Build
      run: |
        cmake --preset debug
        cmake --build --preset debug

    - name: Run shader validation
      run: ./build/debug/tests/goggles_tests "[shader][validation]" -s 2>&1 | tee shader_results.txt || true

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: shader-results
        path: shader_results.txt