name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.8.1
      with:
        pixi-version: v0.40.1
        cache: true
        manifest-path: pixi.toml

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-pixi-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-pixi-ccache-

    - name: Configure ccache
      run: |
        pixi run ccache --set-config=max_size=500M
        pixi run ccache --set-config=compression=true
        pixi run ccache --zero-stats

    # Replaces "Configure with ASAN preset" and "Build" with single Pixi task
    - name: Build
      run: pixi run build-asan

    - name: Show ccache statistics
      run: pixi run ccache --show-stats

    - name: Run Tests
      run: pixi run test-asan

  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.8.1
      with:
        pixi-version: v0.40.1
        cache: true
        manifest-path: pixi.toml

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-pixi-ccache-tidy-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-pixi-ccache-tidy-

    - name: Configure ccache
      run: |
        pixi run ccache --set-config=max_size=500M
        pixi run ccache --set-config=compression=true
        pixi run ccache --zero-stats

    # Replaces "Configure" and "Build with clang-tidy"
    - name: Build with clang-tidy
      run: pixi run build-quality

    - name: Show ccache statistics
      run: pixi run ccache --show-stats
