#!/usr/bin/env bash
set -euo pipefail

die() {
  echo "goggles(AppImage): $*" >&2
  exit 1
}

APPDIR="${APPDIR:-}"
if [[ -z "${APPDIR}" ]]; then
  # Best-effort fallback: resolve from this script's location.
  SELF="$(readlink -f "$0" 2>/dev/null || true)"
  [[ -n "${SELF}" ]] || die "APPDIR not set and unable to resolve AppRun path"
  APPDIR="$(cd "$(dirname "$SELF")" && pwd)"
fi

PORTABLE_HOME=""
if [[ -n "${APPIMAGE:-}" ]]; then
  PORTABLE_HOME="${APPIMAGE}.home"
  if [[ -n "${GOGGLES_PORTABLE:-}" ]] && [[ ! -d "${PORTABLE_HOME}" ]]; then
    if ! mkdir -p "${PORTABLE_HOME}"; then
      echo "Warning: failed to create ${PORTABLE_HOME}, falling back to non-portable mode" >&2
      PORTABLE_HOME=""
    fi
  fi
  if [[ -d "${PORTABLE_HOME}" ]]; then
    export HOME="${PORTABLE_HOME}"
    export XDG_DATA_HOME="${HOME}/.local/share"
    export XDG_CONFIG_HOME="${HOME}/.config"
    export XDG_CACHE_HOME="${HOME}/.cache"
    export XDG_STATE_HOME="${HOME}/.local/state"
  else
    PORTABLE_HOME=""
  fi
fi

DATA_ROOT="${XDG_DATA_HOME:-${HOME}/.local/share}"
MANIFEST_DIR="${DATA_ROOT}/vulkan/implicit_layer.d"
INSTALL_ROOT="${DATA_ROOT}/goggles/vulkan-layers"

VERSION_FILE="${APPDIR}/usr/share/goggles/VERSION"
[[ -f "${VERSION_FILE}" ]] || die "missing VERSION file: ${VERSION_FILE}"
VERSION="$(cat "${VERSION_FILE}")"
[[ -n "${VERSION}" ]] || die "empty VERSION"

VERSION_DIR="${INSTALL_ROOT}/${VERSION}"
LIB64_DST_DIR="${VERSION_DIR}/x86_64"
LIB32_DST_DIR="${VERSION_DIR}/i386"

LIB64_SRC="${APPDIR}/usr/share/goggles/vulkan-layers/x86_64/libgoggles_vklayer.so"
LIB32_SRC="${APPDIR}/usr/share/goggles/vulkan-layers/i386/libgoggles_vklayer.so"

MARKER="${VERSION_DIR}/.installed"

manifest_path_x86_64="${MANIFEST_DIR}/goggles_layer_x86_64.json"
manifest_path_i386="${MANIFEST_DIR}/goggles_layer_i386.json"

usage() {
  cat <<EOF
Usage:
  goggles.AppImage [--self-install-only|--print-install-state|--uninstall-layer|--shader-fetch] [goggles args...]

Notes:
  - First run installs Vulkan implicit layer manifests + layer libraries into:
      ${DATA_ROOT}/vulkan/implicit_layer.d/
      ${DATA_ROOT}/goggles/vulkan-layers/${VERSION}/
  - Shipped assets live inside the AppImage under:
      /usr/share/goggles/
  - Optional RetroArch shader pack (downloaded) lives under:
      ${DATA_ROOT}/goggles/shaders/retroarch/
  - After install, use in Steam launch options:
      goggles -- %command%
EOF
}

print_install_state() {
  echo "APPDIR=${APPDIR}"
  echo "APPIMAGE=${APPIMAGE:-}"
  echo "PORTABLE_HOME=${PORTABLE_HOME}"
  echo "VERSION=${VERSION}"
  echo "DATA_ROOT=${DATA_ROOT}"
  echo "MANIFEST_DIR=${MANIFEST_DIR}"
  echo "INSTALL_ROOT=${INSTALL_ROOT}"
  echo "MARKER=${MARKER}"
  echo "LIB64_SRC=${LIB64_SRC}"
  echo "LIB32_SRC=${LIB32_SRC}"
  echo "LIB64_DST=${LIB64_DST_DIR}/libgoggles_vklayer.so"
  echo "LIB32_DST=${LIB32_DST_DIR}/libgoggles_vklayer.so"
  echo "MANIFEST64=${manifest_path_x86_64}"
  echo "MANIFEST32=${manifest_path_i386}"
  echo "SHADER_PACK_ROOT=${DATA_ROOT}/goggles/shaders/retroarch"
  echo "SHADER_PACK_PRESENT=$([[ -f "${DATA_ROOT}/goggles/shaders/retroarch/crt/zfast-crt.slangp" ]] && echo 1 || echo 0)"
}

atomic_install_file() {
  local src="$1"
  local dst="$2"
  local dst_dir
  dst_dir="$(dirname "$dst")"
  mkdir -p "$dst_dir"

  local tmp
  tmp="$(mktemp "${dst_dir}/.tmp.XXXXXX")"
  chmod --reference="$src" "$tmp" 2>/dev/null || true
  cp -f "$src" "$tmp"
  mv -f "$tmp" "$dst"
}

write_manifest() {
  local layer_name="$1"
  local lib_path="$2"
  local out_path="$3"
  local out_dir
  out_dir="$(dirname "$out_path")"
  mkdir -p "$out_dir"

  local tmp
  tmp="$(mktemp "${out_dir}/.tmp.XXXXXX")"
  cat >"$tmp" <<EOF
{
  "file_format_version": "1.2.0",
  "layer": {
    "name": "${layer_name}",
    "type": "GLOBAL",
    "library_path": "${lib_path}",
    "api_version": "1.3.0",
    "implementation_version": "1",
    "description": "Goggles frame capture layer",
    "functions": {
      "vkNegotiateLoaderLayerInterfaceVersion": "vkNegotiateLoaderLayerInterfaceVersion",
      "vkGetInstanceProcAddr": "vkGetInstanceProcAddr",
      "vkGetDeviceProcAddr": "vkGetDeviceProcAddr"
    },
    "enable_environment": {
      "GOGGLES_CAPTURE": "1"
    },
    "disable_environment": {
      "GOGGLES_CAPTURE_DISABLE": "1"
    }
  }
}
EOF
  chmod 0644 "$tmp" 2>/dev/null || true
  mv -f "$tmp" "$out_path"
}

self_install() {
  [[ -f "${LIB64_SRC}" ]] || die "missing 64-bit layer library in AppImage: ${LIB64_SRC}"
  [[ -f "${LIB32_SRC}" ]] || die "missing 32-bit layer library in AppImage: ${LIB32_SRC}"

  if [[ -f "${MARKER}" ]] && [[ -f "${LIB64_DST_DIR}/libgoggles_vklayer.so" ]] && [[ -f "${LIB32_DST_DIR}/libgoggles_vklayer.so" ]]; then
    # Still refresh manifests to ensure they always point to the active version.
    write_manifest "VK_LAYER_goggles_capture_64" "${LIB64_DST_DIR}/libgoggles_vklayer.so" "${manifest_path_x86_64}"
    write_manifest "VK_LAYER_goggles_capture_32" "${LIB32_DST_DIR}/libgoggles_vklayer.so" "${manifest_path_i386}"
    return 0
  fi

  mkdir -p "${LIB64_DST_DIR}" "${LIB32_DST_DIR}" "${MANIFEST_DIR}"

  atomic_install_file "${LIB64_SRC}" "${LIB64_DST_DIR}/libgoggles_vklayer.so"
  atomic_install_file "${LIB32_SRC}" "${LIB32_DST_DIR}/libgoggles_vklayer.so"

  write_manifest "VK_LAYER_goggles_capture_64" "${LIB64_DST_DIR}/libgoggles_vklayer.so" "${manifest_path_x86_64}"
  write_manifest "VK_LAYER_goggles_capture_32" "${LIB32_DST_DIR}/libgoggles_vklayer.so" "${manifest_path_i386}"

  mkdir -p "${VERSION_DIR}"
  : >"${MARKER}"
  chmod 0644 "${MARKER}" 2>/dev/null || true
}

uninstall_layer() {
  if [[ -f "${manifest_path_x86_64}" ]] && grep -Fq "${VERSION_DIR}" "${manifest_path_x86_64}" 2>/dev/null; then
    rm -f -- "${manifest_path_x86_64}" 2>/dev/null || true
  fi
  if [[ -f "${manifest_path_i386}" ]] && grep -Fq "${VERSION_DIR}" "${manifest_path_i386}" 2>/dev/null; then
    rm -f -- "${manifest_path_i386}" 2>/dev/null || true
  fi
  rm -rf -- "${VERSION_DIR}" 2>/dev/null || true
  echo "Uninstalled Goggles Vulkan layer for version ${VERSION} from ${DATA_ROOT}"
}

shader_fetch() {
  command -v curl >/dev/null 2>&1 || die "curl is required for --shader-fetch"
  command -v tar >/dev/null 2>&1 || die "tar is required for --shader-fetch"

  local dst_root="${DATA_ROOT}/goggles/shaders"
  local dst="${dst_root}/retroarch"
  local tmp
  tmp="$(mktemp -d)"
  trap 'rm -rf "$tmp"' RETURN

  echo "Downloading RetroArch slang-shaders..."
  curl -L --fail -o "$tmp/slang-shaders.tar.gz" \
    "https://github.com/libretro/slang-shaders/archive/refs/heads/master.tar.gz"

  tar -xzf "$tmp/slang-shaders.tar.gz" -C "$tmp"
  local extracted
  extracted="$(find "$tmp" -maxdepth 1 -type d -name 'slang-shaders-*' | head -n 1)"
  [[ -n "${extracted}" ]] || die "failed to locate extracted slang-shaders directory"

  mkdir -p "$dst_root"
  rm -rf "$dst"
  cp -a "$extracted/." "$dst"

  echo "Installed shader pack to: $dst"
}

if [[ $# -gt 0 ]]; then
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --print-install-state)
      print_install_state
      exit 0
      ;;
    --self-install-only)
      self_install
      echo "Layer install complete"
      exit 0
      ;;
    --uninstall-layer)
      uninstall_layer
      exit 0
      ;;
    --shader-fetch)
      shader_fetch
      exit 0
      ;;
  esac
fi

self_install

GOGGLES_BIN="${APPDIR}/usr/bin/goggles"
[[ -x "${GOGGLES_BIN}" ]] || die "missing goggles binary: ${GOGGLES_BIN}"

export GOGGLES_RESOURCE_DIR="${APPDIR}/usr/share/goggles"

DEFAULT_CONFIG="${APPDIR}/usr/share/goggles/config/goggles.toml"
DEFAULT_SHADER="${APPDIR}/usr/share/goggles/shaders/retroarch/crt/zfast-crt.slangp"
XDG_SHADER="${DATA_ROOT}/goggles/shaders/retroarch/crt/zfast-crt.slangp"
XDG_CONFIG="${XDG_CONFIG_HOME:-${HOME}/.config}/goggles/goggles.toml"

extra_args=()
has_config=0
has_shader=0

for arg in "$@"; do
  case "$arg" in
    -c|--config|--config=*)
      has_config=1
      ;;
    -s|--shader|--shader=*)
      has_shader=1
      ;;
  esac
done

if [[ $has_config -eq 0 ]]; then
  if [[ -f "${XDG_CONFIG}" ]]; then
    extra_args+=(--config "${XDG_CONFIG}")
  else
    [[ -f "${DEFAULT_CONFIG}" ]] || die "missing default config: ${DEFAULT_CONFIG}"
    extra_args+=(--config "${DEFAULT_CONFIG}")
  fi
fi

if [[ $has_shader -eq 0 ]]; then
  if [[ -f "${XDG_SHADER}" ]]; then
    extra_args+=(--shader "${XDG_SHADER}")
  else
    [[ -f "${DEFAULT_SHADER}" ]] || die "missing default shader preset: ${DEFAULT_SHADER}"
    extra_args+=(--shader "${DEFAULT_SHADER}")
  fi
fi

export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${LD_LIBRARY_PATH:-}"

exec "${GOGGLES_BIN}" "${extra_args[@]}" "$@"
